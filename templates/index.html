<!DOCTYPE html>
<html>
<head>
    <title>Leaf Disease Prediction</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container">
        <h1>üåø Bottle Gourd Disease Detection System</h1>
        <p class="subtitle">Upload a leaf or fruit image to detect plant diseases using AI ensemble models</p>
        
        <div class="disease-info" style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 30px; font-size: 0.9em; color: #7f8c8d;">
            <h4 style="color: #2c3e50; margin-bottom: 10px;">üî¨ Detectable Diseases:</h4>
            <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                <span style="background: #e8f5e8; padding: 5px 10px; border-radius: 15px; color: #27ae60;">Anthracnose fruit rot</span>
                <span style="background: #e8f5e8; padding: 5px 10px; border-radius: 15px; color: #27ae60;">Anthracnose leaf spot</span>
                <span style="background: #e8f5e8; padding: 5px 10px; border-radius: 15px; color: #27ae60;">Blossom end rot</span>
                <span style="background: #e8f5e8; padding: 5px 10px; border-radius: 15px; color: #27ae60;">Fresh fruit</span>
                <span style="background: #e8f5e8; padding: 5px 10px; border-radius: 15px; color: #27ae60;">Fresh leaf</span>
                <span style="background: #e8f5e8; padding: 5px 10px; border-radius: 15px; color: #27ae60;">Insect damaged leaf</span>
                <span style="background: #e8f5e8; padding: 5px 10px; border-radius: 15px; color: #27ae60;">Yellow mosaic virus</span>
            </div>
        </div>
        
        <div class="upload-section">
            <form id="uploadForm">
                <div class="file-input-wrapper">
                    <input type="file" id="imageInput" name="image" accept="image/*" required>
                    <label for="imageInput" class="file-input-label">
                        üìÅ Choose Image
                    </label>
                </div>
                <button type="submit" id="predictBtn" class="predict-btn" disabled>
                    üîç Predict Disease
                </button>
            </form>
        </div>

        <div id="imagePreview" class="image-preview" style="display: none;">
            <h3>Selected Image:</h3>
            <img id="previewImg" alt="Preview" />
        </div>

        <div id="loadingDiv" class="loading" style="display: none;">
            <div class="spinner"></div>
            <p>Analyzing the leaf image...</p>
        </div>

        <div id="result" class="result-section" style="display: none;">
            <h3>Analysis Result:</h3>
            <div class="result-content">
                <div class="result-image">
                    <img id="resultImg" alt="Analyzed Image" />
                </div>
                <div class="result-text">
                    <div class="prediction-box">
                        <h4>üî¨ Detected Disease:</h4>
                        <p id="predictionText"></p>
                        
                        <div id="allPredictions" style="margin-top: 15px; display: none;">
                            <h5 style="color: #2c3e50; margin-bottom: 10px;">üìä All Class Probabilities:</h5>
                            <div id="probabilitiesList"></div>
                        </div>
                        
                        <div id="modelInfo" style="margin-top: 15px; display: none;">
                            <h5 style="color: #7f8c8d; margin-bottom: 5px;">ü§ñ Model Architecture:</h5>
                            <p id="architectureText" style="font-size: 0.9em; color: #7f8c8d;"></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const form = document.getElementById('uploadForm');
        const imageInput = document.getElementById('imageInput');
        const previewDiv = document.getElementById('imagePreview');
        const previewImg = document.getElementById('previewImg');
        const resultDiv = document.getElementById('result');
        const resultImg = document.getElementById('resultImg');
        const predictionText = document.getElementById('predictionText');
        const predictBtn = document.getElementById('predictBtn');
        const loadingDiv = document.getElementById('loadingDiv');

        // Handle image selection and preview
        imageInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    previewImg.src = e.target.result;
                    previewDiv.style.display = 'block';
                    predictBtn.disabled = false;
                    // Hide previous results
                    resultDiv.style.display = 'none';
                };
                reader.readAsDataURL(file);
            } else {
                previewDiv.style.display = 'none';
                predictBtn.disabled = true;
                resultDiv.style.display = 'none';
            }
        });

        // Handle form submission
        form.onsubmit = async (e) => {
            e.preventDefault();

            const image = imageInput.files[0];
            if (!image) return;

            // Show loading
            loadingDiv.style.display = 'block';
            resultDiv.style.display = 'none';
            predictBtn.disabled = true;

            const formData = new FormData();
            formData.append('image', image);

            try {
                const response = await fetch('/predict', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                
                // Hide loading
                loadingDiv.style.display = 'none';
                
                if (result.prediction) {
                    // Show the same image in results with debugging
                    console.log('Setting result image source:', previewImg.src);
                    console.log('Preview image element:', previewImg);
                    console.log('Result image element:', resultImg);
                    
                    // Clear any previous source and set new one
                    resultImg.src = '';
                    setTimeout(() => {
                        resultImg.src = previewImg.src;
                        console.log('Result image src set to:', resultImg.src);
                    }, 100);
                    
                    // Make sure the image is visible and loaded
                    resultImg.style.display = 'block';
                    resultImg.style.visibility = 'visible';
                    resultImg.style.opacity = '1';
                    
                    resultImg.onload = function() {
                        console.log('Result image loaded successfully');
                        console.log('Image dimensions:', this.naturalWidth, 'x', this.naturalHeight);
                    };
                    resultImg.onerror = function() {
                        console.error('Failed to load result image');
                        console.error('Image src:', this.src);
                    };
                    
                    // Display main prediction
                    let predictionHtml = `<strong>${result.prediction}</strong>`;
                    if (result.confidence) {
                        predictionHtml += `<br><small style="color: #7f8c8d;">Confidence: ${result.confidence}</small>`;
                    }
                    
                    predictionText.innerHTML = predictionHtml;
                    predictionText.className = 'prediction-success';
                    
                    // Show all class probabilities if available
                    const allPredictionsDiv = document.getElementById('allPredictions');
                    const probabilitiesList = document.getElementById('probabilitiesList');
                    
                    if (result.all_predictions) {
                        let probabilitiesHtml = '';
                        for (const [className, probability] of Object.entries(result.all_predictions)) {
                            const isHighest = className === result.prediction;
                            probabilitiesHtml += `
                                <div style="padding: 5px; margin: 2px 0; border-radius: 5px; ${isHighest ? 'background-color: #d5f4e6; font-weight: bold;' : 'background-color: #f8f9fa;'}">
                                    <span style="color: #2c3e50;">${className}:</span> 
                                    <span style="color: #27ae60; float: right;">${probability}</span>
                                </div>
                            `;
                        }
                        probabilitiesList.innerHTML = probabilitiesHtml;
                        allPredictionsDiv.style.display = 'block';
                    }
                    
                    // Show model info if available
                    const modelInfoDiv = document.getElementById('modelInfo');
                    const architectureText = document.getElementById('architectureText');
                    
                    if (result.model_info) {
                        // Format base models as individual badges
                        let baseModelsHtml = '';
                        if (result.model_info.base_models && Array.isArray(result.model_info.base_models)) {
                            baseModelsHtml = result.model_info.base_models.map(model => 
                                `<span style="background: #e3f2fd; color: #1976d2; padding: 3px 8px; border-radius: 12px; font-size: 0.8em; margin: 2px; display: inline-block;">${model}</span>`
                            ).join('');
                        } else {
                            baseModelsHtml = `<span style="background: #e3f2fd; color: #1976d2; padding: 3px 8px; border-radius: 12px; font-size: 0.8em;">${result.model_info.base_models}</span>`;
                        }
                        
                        architectureText.innerHTML = `
                            <strong>${result.model_info.architecture}</strong><br>
                            <div style="margin-top: 8px;">
                                <small style="color: #666;">Base Models (${result.model_info.total_models}):</small><br>
                                <div style="margin-top: 5px;">${baseModelsHtml}</div>
                            </div>
                            <div style="margin-top: 8px;">
                                <small style="color: #666;">Classes: ${result.model_info.classes} | Device: ${result.model_info.device}</small>
                            </div>
                        `;
                        modelInfoDiv.style.display = 'block';
                    }
                    
                    resultDiv.style.display = 'block';
                } else {
                    predictionText.innerHTML = "Error: " + (result.error || "Unknown error occurred");
                    predictionText.className = 'prediction-error';
                    resultDiv.style.display = 'block';
                }
            } catch (error) {
                loadingDiv.style.display = 'none';
                predictionText.innerHTML = "Error: Failed to connect to server";
                predictionText.className = 'prediction-error';
                resultDiv.style.display = 'block';
            }
            
            predictBtn.disabled = false;
        };
    </script>
</body>
</html>
